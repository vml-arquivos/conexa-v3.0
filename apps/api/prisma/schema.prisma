// ============================================================================
// CONEXA - Schema Prisma v1.2 (Proposto - Matriz Curricular)
// Plataforma de Gestão Educacional para Educação Infantil (0-4 anos)
// ============================================================================
// PRINCÍPIOS:
// - Multi-tenant desde a raiz (mantenedora → unidades → turmas)
// - RBAC rigoroso em 5 níveis (Dev, Mantenedora, Staff Central, Unidade, Professor)
// - Auditoria completa (createdAt, updatedAt, createdBy, updatedBy)
// - Conformidade BNCC e Currículo em Movimento DF
// - Segurança de dados de crianças (sensíveis)
// - IA como suporte com validação humana
// ============================================================================
// CHANGELOG v1.0 → v1.1:
// - Criado model ClassroomTeacher para relação explícita professor-turma
// - Adicionado classroomId opcional em MaterialRequest (requisição por turma)
// - Criado model UserRoleUnitScope para escopo multi-unidade (Staff Central)
// - Substituído String por Json em campos estruturados (activities, tags, etc)
// - Validados todos os índices e chaves de escopo para produção
// ============================================================================
// CHANGELOG v1.1 → v1.2:
// - Criado model CurriculumMatrix (matriz curricular versionada)
// - Criado model CurriculumMatrixEntry (linha da matriz = dia letivo + objetivos)
// - Ajustado Planning: adicionado curriculumMatrixId e pedagogicalContent
// - Ajustado DiaryEvent: adicionado curriculumEntryId e eventDate obrigatório
// - Adicionado enum CampoDeExperiencia para os 5 campos da BNCC
// - Garantida compatibilidade com v1.1 (sem breaking changes críticos)
// ============================================================================

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

// ============================================================================
// 1. ENUMS - Tipos e Papéis
// ============================================================================

/// Níveis de acesso no sistema (RBAC)
enum RoleLevel {
  DEVELOPER // Acesso total sistêmico
  MANTENEDORA // Gestão administrativa global
  STAFF_CENTRAL // Coordenação pedagógica geral e psicologia
  UNIDADE // Direção, coordenação pedagógica local, administrativo, nutrição
  PROFESSOR // Acesso exclusivo às suas turmas
}

/// Papéis específicos dentro de cada nível
enum RoleType {
  DEVELOPER
  MANTENEDORA_ADMIN
  MANTENEDORA_FINANCEIRO
  STAFF_CENTRAL_PEDAGOGICO
  STAFF_CENTRAL_PSICOLOGIA
  UNIDADE_DIRETOR
  UNIDADE_COORDENADOR_PEDAGOGICO
  UNIDADE_ADMINISTRATIVO
  UNIDADE_NUTRICIONISTA
  PROFESSOR
  PROFESSOR_AUXILIAR
}

/// Status de usuário
enum UserStatus {
  ATIVO
  INATIVO
  SUSPENSO
  CONVIDADO
}

/// Gênero
enum Gender {
  MASCULINO
  FEMININO
  OUTRO
  NAO_INFORMADO
}

/// Status de matrícula
enum EnrollmentStatus {
  ATIVA
  PAUSADA
  CONCLUIDA
  CANCELADA
}

/// Tipo de evento no diário de bordo
enum DiaryEventType {
  ATIVIDADE_PEDAGOGICA
  REFEICAO
  HIGIENE
  SONO
  COMPORTAMENTO
  DESENVOLVIMENTO
  SAUDE
  FAMILIA
  OBSERVACAO
  AVALIACAO
  OUTRO
}

/// Status de evento no diário
enum DiaryEventStatus {
  RASCUNHO
  PUBLICADO
  REVISADO
  ARQUIVADO
}

/// Tipo de planejamento
enum PlanningType {
  SEMANAL
  MENSAL
  TRIMESTRAL
  SEMESTRAL
  ANUAL
}

/// Status de planejamento
enum PlanningStatus {
  RASCUNHO
  PUBLICADO
  EM_EXECUCAO
  CONCLUIDO
  CANCELADO
}

/// Status de frequência
enum AttendanceStatus {
  PRESENTE
  AUSENTE
  JUSTIFICADO
  ATRASO
}

/// Tipo de requisição de material
enum MaterialRequestType {
  CONSUMIVEL
  PERMANENTE
  HIGIENE
  LIMPEZA
  PEDAGOGICO
  ALIMENTACAO
  OUTRO
}

/// Status de requisição
enum RequestStatus {
  RASCUNHO
  SOLICITADO
  APROVADO
  REJEITADO
  ENTREGUE
  CANCELADO
}

/// Tipo de restrição alimentar
enum DietaryRestrictionType {
  ALERGIA
  INTOLERANCIA
  PREFERENCIA
  RELIGIOSA
  MEDICA
  OUTRA
}

/// Tipo de log de auditoria
enum AuditLogAction {
  CREATE
  UPDATE
  DELETE
  VIEW
  EXPORT
  IMPORT
  LOGIN
  LOGOUT
  PERMISSION_CHANGE
  ROLE_CHANGE
}

/// Entidade auditada
enum AuditLogEntity {
  USER
  CHILD
  ENROLLMENT
  CLASSROOM
  PLANNING
  DIARY_EVENT
  ATTENDANCE
  MATERIAL_REQUEST
  DIETARY_RESTRICTION
  CURRICULUM_MATRIX
  CURRICULUM_MATRIX_ENTRY
  ROLE
  PERMISSION
  UNIT
  MANTENEDORA
}

/// Papel do professor na turma
enum ClassroomTeacherRole {
  MAIN // Professor titular
  AUXILIARY // Professor auxiliar
  SUBSTITUTE // Professor substituto
}

/// Campos de Experiência da BNCC para Educação Infantil
enum CampoDeExperiencia {
  O_EU_O_OUTRO_E_O_NOS
  CORPO_GESTOS_E_MOVIMENTOS
  TRACOS_SONS_CORES_E_FORMAS
  ESCUTA_FALA_PENSAMENTO_E_IMAGINACAO
  ESPACOS_TEMPOS_QUANTIDADES_RELACOES_E_TRANSFORMACOES
}

// ============================================================================
// 2. ESTRUTURA ORGANIZACIONAL
// ============================================================================

/// Mantenedora: Organização raiz que gerencia múltiplas unidades
model Mantenedora {
  id      String  @id @default(cuid())
  name    String  @db.VarChar(255)
  cnpj    String  @unique @db.VarChar(18)
  email   String  @unique @db.VarChar(255)
  phone   String? @db.VarChar(20)
  website String? @db.VarChar(255)

  // Endereço
  address String? @db.VarChar(255)
  city    String? @db.VarChar(100)
  state   String? @db.VarChar(2)
  zipCode String? @db.VarChar(10)

  // Status e configurações
  isActive Boolean @default(true)
  plan     String  @default("basic") // basic, professional, enterprise
  maxUnits Int     @default(1)
  maxUsers Int     @default(50)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?  @db.VarChar(255)
  updatedBy String?  @db.VarChar(255)

  // Relações
  units                Unit[]
  users                User[]
  roles                Role[]
  children             Child[]
  curriculumMatrices   CurriculumMatrix[]
  plannings            Planning[]
  diaryEvents          DiaryEvent[]
  attendances          Attendance[]
  materialRequests     MaterialRequest[]
  reportBases          ReportBase[]
  aiContexts           AIContext[]
  auditLogs            AuditLog[]
  pedidosCompra        PedidoCompra[]
  solicitacoesCorrecao SolicitacaoCorrecao[]
  arquivos             Arquivo[]
  coordenacoesReuniao  CoordenacaoReuniao[]
  formacoes            Formacao[]
  atendimentosPais     AtendimentoPais[]
  relatoriosFoto       RelatorioFoto[]
  rdixTemplates        RDIXTemplate[]
  rdixInstancias       RDIXInstancia[]
  alertasOperacionais  AlertaOperacional[]
  templatesOffline     TemplateOffline[]

  @@index([cnpj])
  @@index([isActive])
}

/// Unidade: Creche/Escola dentro de uma mantenedora
model Unit {
  id            String @id @default(cuid())
  mantenedoraId String
  name          String @db.VarChar(255)
  code          String @db.VarChar(50)

  // Endereço
  address String? @db.VarChar(255)
  city    String? @db.VarChar(100)
  state   String? @db.VarChar(2)
  zipCode String? @db.VarChar(10)

  // Contato
  email String? @db.VarChar(255)
  phone String? @db.VarChar(20)

  // Configurações pedagógicas
  capacity        Int    @default(100)
  ageGroupsServed String @default("0-4") // Faixa etária atendida

  // Status
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?  @db.VarChar(255)
  updatedBy String?  @db.VarChar(255)

  // Relações
  mantenedora          Mantenedora           @relation(fields: [mantenedoraId], references: [id], onDelete: Cascade)
  users                User[]
  classrooms           Classroom[]
  children             Child[]
  plannings            Planning[]
  diaryEvents          DiaryEvent[]
  attendances          Attendance[]
  materialRequests     MaterialRequest[]
  stockItems           StockItem[]
  reportBases          ReportBase[]
  auditLogs            AuditLog[]
  userRoleUnitScopes   UserRoleUnitScope[]
  pedidosCompra        PedidoCompra[]
  solicitacoesCorrecao SolicitacaoCorrecao[]
  aiContexts           AIContext[]

  dailyMetrics DailyMetric[]

  @@unique([mantenedoraId, code])
  @@index([mantenedoraId])
  @@index([isActive])
}

// ============================================================================
// 3. USUÁRIOS E CONTROLE DE ACESSO
// ============================================================================

/// Usuário do sistema
model User {
  id            String  @id @default(cuid())
  mantenedoraId String
  unitId        String?

  // Credenciais
  email    String @unique @db.VarChar(255)
  password String @db.VarChar(255)

  // Informações pessoais
  firstName String  @db.VarChar(100)
  lastName  String  @db.VarChar(100)
  cpf       String? @unique @db.VarChar(14)
  phone     String? @db.VarChar(20)

  // Status
  status        UserStatus @default(ATIVO)
  emailVerified Boolean    @default(false)
  lastLogin     DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?  @db.VarChar(255)
  updatedBy String?  @db.VarChar(255)

  // Relações
  mantenedora             Mantenedora        @relation(fields: [mantenedoraId], references: [id], onDelete: Cascade)
  unit                    Unit?              @relation(fields: [unitId], references: [id], onDelete: SetNull)
  roles                   UserRole[]
  classroomTeachers       ClassroomTeacher[]
  diaryEventsCreated      DiaryEvent[]       @relation("CreatedBy")
  diaryEventsReviewed     DiaryEvent[]       @relation("ReviewedBy")
  planningsCreated        Planning[]         @relation("CreatedBy")
  attendancesRecorded     Attendance[]       @relation("RecordedBy")
  materialRequestsCreated MaterialRequest[]  @relation("CreatedBy")
  auditLogs               AuditLog[]         @relation("User")

  @@index([mantenedoraId])
  @@index([unitId])
  @@index([email])
  @@index([status])
}

/// Papel/Role no sistema
model Role {
  id            String @id @default(cuid())
  mantenedoraId String

  name        String    @db.VarChar(100)
  description String?   @db.Text
  level       RoleLevel
  type        RoleType

  // Status
  isActive Boolean @default(true)
  isCustom Boolean @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  mantenedora Mantenedora      @relation(fields: [mantenedoraId], references: [id], onDelete: Cascade)
  permissions RolePermission[]
  users       UserRole[]

  @@unique([mantenedoraId, type])
  @@index([mantenedoraId])
  @@index([level])
}

/// Associação entre usuário e papel
model UserRole {
  id     String @id @default(cuid())
  userId String
  roleId String

  // Escopo de acesso
  scopeLevel RoleLevel // Nível de acesso que este papel confere

  // Status
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  user       User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  role       Role                @relation(fields: [roleId], references: [id], onDelete: Cascade)
  unitScopes UserRoleUnitScope[]

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@index([scopeLevel])
}

/// Escopo de unidades para um UserRole (permite acesso a múltiplas unidades)
model UserRoleUnitScope {
  id         String @id @default(cuid())
  userRoleId String
  unitId     String

  // Timestamps
  createdAt DateTime @default(now())

  // Relações
  userRole UserRole @relation(fields: [userRoleId], references: [id], onDelete: Cascade)
  unit     Unit     @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@unique([userRoleId, unitId])
  @@index([userRoleId])
  @@index([unitId])
}

/// Permissão no sistema
model Permission {
  id String @id @default(cuid())

  name        String  @unique @db.VarChar(100)
  description String? @db.Text
  resource    String  @db.VarChar(100) // ex: "children", "planning", "diary"
  action      String  @db.VarChar(50) // ex: "create", "read", "update", "delete"

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  roles RolePermission[]

  @@unique([resource, action])
  @@index([resource])
}

/// Associação entre papel e permissão
model RolePermission {
  id           String @id @default(cuid())
  roleId       String
  permissionId String

  // Timestamps
  createdAt DateTime @default(now())

  // Relações
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

// ============================================================================
// 4. CRIANÇAS E MATRÍCULAS
// ============================================================================

/// Criança/Aluno
model Child {
  id            String @id @default(cuid())
  mantenedoraId String
  unitId        String

  // Identificação
  firstName   String   @db.VarChar(100)
  lastName    String   @db.VarChar(100)
  dateOfBirth DateTime
  gender      Gender   @default(NAO_INFORMADO)

  // Documentação
  cpf String? @unique @db.VarChar(14)
  rg  String? @db.VarChar(20)

  // Contato de emergência
  emergencyContactName  String? @db.VarChar(255)
  emergencyContactPhone String? @db.VarChar(20)

  // Foto
  photoUrl String? @db.VarChar(500)
  
  // Informações de saúde
  bloodType         String? @db.VarChar(5)
  allergies         String? @db.Text
  medicalConditions String? @db.Text
  medicationNeeds   String? @db.Text

  // Status
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?  @db.VarChar(255)
  updatedBy String?  @db.VarChar(255)

  // Relações
  mantenedora         Mantenedora          @relation(fields: [mantenedoraId], references: [id], onDelete: Cascade)
  unit                Unit                 @relation(fields: [unitId], references: [id], onDelete: Cascade)
  enrollments         Enrollment[]
  diaryEvents         DiaryEvent[]
  attendances         Attendance[]
  dietaryRestrictions DietaryRestriction[]
  reportBases         ReportBase[]
  aiContexts          AIContext[]
  atendimentosPais         AtendimentoPais[]
  rdixInstancias           RDIXInstancia[]
  developmentObservations  DevelopmentObservation[]
  developmentReports       DevelopmentReport[]

  @@index([mantenedoraId])
  @@index([unitId])
  @@index([isActive])
  @@index([dateOfBirth])
}

/// Matrícula: Associação entre criança e turma
model Enrollment {
  id          String @id @default(cuid())
  childId     String
  classroomId String

  // Período
  enrollmentDate DateTime
  withdrawalDate DateTime?

  // Status
  status EnrollmentStatus @default(ATIVA)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?  @db.VarChar(255)
  updatedBy String?  @db.VarChar(255)

  // Relações
  child     Child     @relation(fields: [childId], references: [id], onDelete: Cascade)
  classroom Classroom @relation(fields: [classroomId], references: [id], onDelete: Cascade)

  @@unique([childId, classroomId])
  @@index([childId])
  @@index([classroomId])
  @@index([status])
  @@index([enrollmentDate])
}

// ============================================================================
// 5. TURMAS E ESTRUTURA PEDAGÓGICA
// ============================================================================

/// Turma/Sala de aula
model Classroom {
  id     String @id @default(cuid())
  unitId String

  // Identificação
  name String @db.VarChar(100)
  code String @db.VarChar(50)

  // Configuração pedagógica
  ageGroupMin Int @default(0) // meses
  ageGroupMax Int @default(48) // meses
  capacity    Int @default(15)

  // Status
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?  @db.VarChar(255)
  updatedBy String?  @db.VarChar(255)

  // Relações
  unit             Unit               @relation(fields: [unitId], references: [id], onDelete: Cascade)
  teachers         ClassroomTeacher[]
  enrollments      Enrollment[]
  plannings        Planning[]
  diaryEvents      DiaryEvent[]
  attendances      Attendance[]
  materialRequests MaterialRequest[]
  reportBases      ReportBase[]

  @@unique([unitId, code])
  @@index([unitId])
  @@index([isActive])
}

/// Associação entre professor (User) e turma (Classroom)
model ClassroomTeacher {
  id          String               @id @default(cuid())
  classroomId String
  teacherId   String
  role        ClassroomTeacherRole @default(MAIN)

  // Status
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  classroom Classroom @relation(fields: [classroomId], references: [id], onDelete: Cascade)
  teacher   User      @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@unique([classroomId, teacherId])
  @@index([classroomId])
  @@index([teacherId])
  @@index([role])
}

// ============================================================================
// 6. PLANEJAMENTO PEDAGÓGICO
// ============================================================================

/// Matriz Curricular (versão anual da matriz oficial)
model CurriculumMatrix {
  id            String @id @default(cuid())
  mantenedoraId String

  // Identificação
  name    String @db.VarChar(255)
  year    Int // Ex: 2026
  segment String @db.VarChar(10) // Ex: "EI01", "EI02", "EI03"
  version Int    @default(1)

  // Metadados
  description String? @db.Text
  sourceUrl   String? @db.VarChar(500) // URL do documento original

  // Status
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?  @db.VarChar(255)
  updatedBy String?  @db.VarChar(255)

  // Relações
  mantenedora Mantenedora             @relation(fields: [mantenedoraId], references: [id], onDelete: Cascade)
  entries     CurriculumMatrixEntry[]
  plannings   Planning[]

  @@unique([mantenedoraId, year, segment, version])
  @@index([mantenedoraId])
  @@index([year])
  @@index([segment])
  @@index([isActive])
}

/// Entrada da Matriz Curricular (linha da matriz = dia letivo + objetivos)
model CurriculumMatrixEntry {
  id       String @id @default(cuid())
  matrixId String

  // Data e organização temporal
  date       DateTime // Data letiva específica
  weekOfYear Int
  dayOfWeek  Int // 1=Segunda, 2=Terça, ..., 5=Sexta
  bimester   Int? // 1, 2, 3, 4

  // Conteúdo Normativo (IMUTÁVEL)
  campoDeExperiencia CampoDeExperiencia
  objetivoBNCC       String             @db.Text // Transcrição literal
  objetivoBNCCCode   String?            @db.VarChar(20) // Ex: "EI01EO03"
  objetivoCurriculo  String             @db.Text // Transcrição literal do Currículo em Movimento DF

  // Sugestões Pedagógicas (EDITÁVEIS na prática)
  intencionalidade String? @db.Text
  exemploAtividade String? @db.Text

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  matrix      CurriculumMatrix @relation(fields: [matrixId], references: [id], onDelete: Cascade)
  diaryEvents DiaryEvent[]

  @@unique([matrixId, date])
  @@index([matrixId])
  @@index([date])
  @@index([weekOfYear])
  @@index([campoDeExperiencia])
  @@index([objetivoBNCCCode])
}

/// Template de planejamento (reutilizável)
model PlanningTemplate {
  id String @id @default(cuid())

  // Identificação
  name        String  @db.VarChar(255)
  description String? @db.Text

  // Estrutura (JSONB)
  sections Json // array de seções
  fields   Json // campos customizáveis

  // Status
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  plannings Planning[]

  @@index([isActive])
}

/// Planejamento pedagógico (instância)
model Planning {
  id                 String  @id @default(cuid())
  mantenedoraId      String
  unitId             String
  classroomId        String
  templateId         String?
  curriculumMatrixId String? // Nova relação com a matriz curricular

  // Identificação
  title       String  @db.VarChar(255)
  description String? @db.Text

  // Período
  type      PlanningType
  startDate DateTime
  endDate   DateTime

  // Conteúdo (MANTIDO para compatibilidade)
  objectives String? @db.Text
  activities Json? // atividades estruturadas
  resources  Json? // recursos necessários
  evaluation String? @db.Text

  // Alinhamento curricular (MANTIDO para compatibilidade)
  bnccAreas           Json? // áreas BNCC
  curriculumAlignment String? @db.Text // Currículo em Movimento DF

  // Conteúdo Pedagógico de Autoria Docente (NOVO)
  pedagogicalContent Json? // Experiências, materiais e estratégias por dia

  // Status
  status PlanningStatus @default(RASCUNHO)

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdBy   String?   @db.VarChar(255)
  updatedBy   String?   @db.VarChar(255)
  publishedAt DateTime?

  // Relações
  mantenedora      Mantenedora       @relation(fields: [mantenedoraId], references: [id], onDelete: Cascade)
  unit             Unit              @relation(fields: [unitId], references: [id], onDelete: Cascade)
  classroom        Classroom         @relation(fields: [classroomId], references: [id], onDelete: Cascade)
  template         PlanningTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  curriculumMatrix CurriculumMatrix? @relation(fields: [curriculumMatrixId], references: [id], onDelete: SetNull)
  createdByUser    User?             @relation("CreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  diaryEvents      DiaryEvent[]

  @@index([mantenedoraId])
  @@index([unitId])
  @@index([classroomId])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
}

// ============================================================================
// 7. DIÁRIO DE BORDO PEDAGÓGICO
// ============================================================================

/// Evento no diário de bordo (registro pedagógico)
model DiaryEvent {
  id                String  @id @default(cuid())
  mantenedoraId     String
  unitId            String
  classroomId       String
  childId           String
  planningId        String?
  curriculumEntryId String? // Opcional: vínculo com entrada da matriz curricular

  // Identificação
  type        DiaryEventType
  title       String         @db.VarChar(255)
  description String         @db.Text
  eventDate   DateTime // Data do evento (OBRIGATÓRIO para rastreabilidade)

  // Observações e desenvolvimento
  observations     String? @db.Text
  developmentNotes String? @db.Text // Marcos de desenvolvimento
  behaviorNotes    String? @db.Text

  // Micro-gestos (JSONB)
  medicaoAlimentar  Json?
  sonoMinutos       Json?
  trocaFraldaStatus Json?
  // Dados estruturados para IA (JSONB)
  tags              Json? // tags para categorização
  aiContext         Json? // contexto para agentes IA

  // Mídia (JSONB)
  mediaUrls Json? // array de URLs de mídia

  // Status
  status DiaryEventStatus @default(RASCUNHO)

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdBy   String?   @db.VarChar(255)
  reviewedBy  String?   @db.VarChar(255)
  publishedAt DateTime?

  // Relações
  mantenedora     Mantenedora           @relation(fields: [mantenedoraId], references: [id], onDelete: Cascade)
  unit            Unit                  @relation(fields: [unitId], references: [id], onDelete: Cascade)
  classroom       Classroom             @relation(fields: [classroomId], references: [id], onDelete: Cascade)
  child           Child                 @relation(fields: [childId], references: [id], onDelete: Cascade)
  planning        Planning?             @relation(fields: [planningId], references: [id], onDelete: SetNull)
  curriculumEntry CurriculumMatrixEntry? @relation(fields: [curriculumEntryId], references: [id], onDelete: SetNull)
  createdByUser   User?                 @relation("CreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  reviewedByUser  User?                 @relation("ReviewedBy", fields: [reviewedBy], references: [id], onDelete: SetNull)

  @@index([mantenedoraId])
  @@index([unitId])
  @@index([classroomId])
  @@index([childId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@index([eventDate])
  @@index([curriculumEntryId])
}

// ============================================================================
// 8. FREQUÊNCIA
// ============================================================================

/// Registro de frequência
model Attendance {
  id            String @id @default(cuid())
  mantenedoraId String
  unitId        String
  classroomId   String
  childId       String

  // Data
  date DateTime

  // Status
  status        AttendanceStatus @default(PRESENTE)
  justification String?          @db.Text

  // Timestamps
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  recordedBy String?  @db.VarChar(255)

  // Relações
  mantenedora    Mantenedora @relation(fields: [mantenedoraId], references: [id], onDelete: Cascade)
  unit           Unit        @relation(fields: [unitId], references: [id], onDelete: Cascade)
  classroom      Classroom   @relation(fields: [classroomId], references: [id], onDelete: Cascade)
  child          Child       @relation(fields: [childId], references: [id], onDelete: Cascade)
  recordedByUser User?       @relation("RecordedBy", fields: [recordedBy], references: [id], onDelete: SetNull)

  @@unique([classroomId, childId, date])
  @@index([mantenedoraId])
  @@index([unitId])
  @@index([classroomId])
  @@index([childId])
  @@index([date])
}

// ============================================================================
// 9. NUTRIÇÃO E RESTRIÇÕES ALIMENTARES
// ============================================================================

/// Restrição alimentar
model DietaryRestriction {
  id      String @id @default(cuid())
  childId String

  // Identificação
  type        DietaryRestrictionType
  name        String                 @db.VarChar(100)
  description String?                @db.Text

  // Detalhes
  severity       String? @db.VarChar(50) // leve, moderada, severa
  allowedFoods   String? @db.Text
  forbiddenFoods String? @db.Text

  // Status
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?  @db.VarChar(255)

  // Relações
  child Child @relation(fields: [childId], references: [id], onDelete: Cascade)

  @@index([childId])
  @@index([isActive])
}

// ============================================================================
// 10. REQUISIÇÃO E ESTOQUE DE MATERIAIS
// ============================================================================

/// Requisição de material
model MaterialRequest {
  id            String  @id @default(cuid())
  mantenedoraId String
  unitId        String
  classroomId   String? // Opcional: permite requisição por turma

  // Identificação
  code        String  @db.VarChar(50)
  title       String  @db.VarChar(255)
  description String? @db.Text

  // Tipo e quantidade
  type          MaterialRequestType
  quantity      Int
  estimatedCost Float?

  // Status
  status   RequestStatus @default(RASCUNHO)
  priority String        @default("normal") // baixa, normal, alta, urgente

  // Datas
  requestedDate DateTime  @default(now())
  requiredDate  DateTime?
  approvedDate  DateTime?
  deliveredDate DateTime?

  // Timestamps
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  createdBy  String?  @db.VarChar(255)
  approvedBy String?  @db.VarChar(255)

  // Relações
  mantenedora   Mantenedora @relation(fields: [mantenedoraId], references: [id], onDelete: Cascade)
  unit          Unit        @relation(fields: [unitId], references: [id], onDelete: Cascade)
  classroom     Classroom?  @relation(fields: [classroomId], references: [id], onDelete: SetNull)
  createdByUser User?       @relation("CreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  items         MaterialRequestItem[]

  @@unique([unitId, code])
  @@index([mantenedoraId])
  @@index([unitId])
  @@index([classroomId])
  @@index([status])
  @@index([requestedDate])
}

/// Item de estoque
model StockItem {
  id     String @id @default(cuid())
  unitId String

  // Identificação
  code        String  @db.VarChar(50)
  name        String  @db.VarChar(255)
  description String? @db.Text

  // Quantidade
  quantity        Int @default(0)
  minimumQuantity Int @default(0)

  // Localização
  location String? @db.VarChar(100)

  // Status
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  unit Unit @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@unique([unitId, code])
  @@index([unitId])
  @@index([isActive])
  @@index([quantity])
}

// ============================================================================
// 11. AUDITORIA E LOGS
// ============================================================================

/// Log de auditoria: rastreamento de todas as ações no sistema
model AuditLog {
  id            String  @id @default(cuid())
  mantenedoraId String
  unitId        String?
  userId        String?

  // Ação
  action   AuditLogAction
  entity   AuditLogEntity
  entityId String         @db.VarChar(255)

  // Detalhes (JSONB)
  description String? @db.Text
  changes     Json? // antes/depois
  ipAddress   String? @db.VarChar(50)
  userAgent   String? @db.Text

  // Timestamps
  createdAt DateTime @default(now())

  // Relações
  mantenedora Mantenedora @relation(fields: [mantenedoraId], references: [id], onDelete: Cascade)
  unit        Unit?       @relation(fields: [unitId], references: [id], onDelete: SetNull)
  user        User?       @relation("User", fields: [userId], references: [id], onDelete: SetNull)

  @@index([mantenedoraId])
  @@index([unitId])
  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([entityId])
  @@index([createdAt])
}

// ============================================================================
// 12. RELATÓRIOS OFICIAIS (RIA/RDIC - DF)
// ============================================================================

/// Base para geração de relatórios oficiais
model ReportBase {
  id            String @id @default(cuid())
  mantenedoraId String
  unitId        String
  classroomId   String
  childId       String

  // Período do relatório
  reportType String   @db.VarChar(50) // RIA, RDIC, etc
  period     String   @db.VarChar(50) // mensal, trimestral, anual
  startDate  DateTime
  endDate    DateTime

  // Dados agregados (JSONB)
  attendanceRate     Float?
  developmentSummary Json? // resumo de desenvolvimento
  pedagogicalNotes   String? @db.Text
  familyObservations String? @db.Text

  // Status
  isGenerated Boolean   @default(false)
  generatedAt DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  mantenedora Mantenedora @relation(fields: [mantenedoraId], references: [id], onDelete: Cascade)
  unit        Unit        @relation(fields: [unitId], references: [id], onDelete: Cascade)
  classroom   Classroom   @relation(fields: [classroomId], references: [id], onDelete: Cascade)
  child       Child       @relation(fields: [childId], references: [id], onDelete: Cascade)

  @@unique([unitId, classroomId, childId, reportType, period, startDate])
  @@index([mantenedoraId])
  @@index([unitId])
  @@index([classroomId])
  @@index([childId])
  @@index([reportType])
  @@index([startDate])
}

// ============================================================================
// 13. CONTEXTO PARA AGENTES IA
// ============================================================================

/// Histórico de contexto para agentes IA (suporte, não decisão)
model AIContext {
  id            String @id @default(cuid())
  mantenedoraId String
  unitId        String
  childId       String

  // Contexto
  type             String @db.VarChar(100) // desenvolvimento, comportamento, saúde, etc
  summary          String @db.Text // Resumo estruturado
  recentEvents     Json // eventos recentes
  trends           Json? // tendências identificadas
  suggestedActions Json? // ações sugeridas (não automáticas)

  // Versionamento
  version Int @default(1)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  mantenedora Mantenedora @relation(fields: [mantenedoraId], references: [id], onDelete: Cascade)
  unit        Unit        @relation(fields: [unitId], references: [id], onDelete: Cascade)
  child       Child       @relation(fields: [childId], references: [id], onDelete: Cascade)

  @@index([mantenedoraId])
  @@index([unitId])
  @@index([childId])
  @@index([type])
  @@index([version])
}

// ============================================================================
// FIM DO SCHEMA v1.1
// ============================================================================

enum DailyMetricType {
  DIARY
  ACCESS
}

model DailyMetric {
  id        String          @id @default(cuid())
  unitId    String
  date      DateTime
  type      DailyMetricType
  count     Int             @default(0)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  unit Unit @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@unique([unitId, date, type])
  @@index([unitId, date])
  @@index([type, date])
}

// ============================================================================
// 14. PEDIDO DE COMPRA (Unidade → Mantenedora)
// ============================================================================

/// Status do pedido de compra consolidado pela unidade
enum StatusPedidoCompra {
  RASCUNHO
  ENVIADO
  EM_ANALISE
  COMPRADO
  EM_ENTREGA
  ENTREGUE
  CANCELADO
}

/// Pedido de Compra consolidado mensalmente pela unidade para a mantenedora
model PedidoCompra {
  id            String @id @default(cuid())
  mantenedoraId String
  unitId        String

  /// Mês/ano de referência (ex.: 2026-03)
  mesReferencia String @db.VarChar(7)

  /// Status do pedido
  status StatusPedidoCompra @default(RASCUNHO)

  /// Observações da unidade
  observacoes String? @db.Text

  /// Quem consolidou
  consolidadoPor String? @db.VarChar(255)

  /// Timestamps
  criadoEm     DateTime  @default(now())
  atualizadoEm DateTime  @updatedAt
  enviadoEm    DateTime?
  entregueEm   DateTime?

  /// Relações
  mantenedora Mantenedora        @relation(fields: [mantenedoraId], references: [id], onDelete: Cascade)
  unit        Unit               @relation(fields: [unitId], references: [id], onDelete: Cascade)
  itens       ItemPedidoCompra[]

  @@index([mantenedoraId])
  @@index([unitId])
  @@index([mesReferencia])
  @@index([status])
}

/// Item individual de um pedido de compra
model ItemPedidoCompra {
  id             String @id @default(cuid())
  pedidoCompraId String

  /// Categoria do item
  categoria MaterialRequestType

  /// Descrição do item
  descricao String @db.VarChar(255)

  /// Quantidade solicitada
  quantidade Int

  /// Unidade de medida (unidade, caixa, pacote, etc.)
  unidadeMedida String? @db.VarChar(50)

  /// Custo estimado
  custoEstimado Float?

  /// Requisições de material que originaram este item
  requisicaoIds Json?

  /// Timestamps
  criadoEm DateTime @default(now())

  /// Relação
  pedidoCompra PedidoCompra @relation(fields: [pedidoCompraId], references: [id], onDelete: Cascade)

  @@index([pedidoCompraId])
  @@index([categoria])
}

// ============================================================================
// 15. SOLICITAÇÃO DE CORREÇÃO (Central/Unidade → Professor)
// ============================================================================

/// Status da solicitação de correção
enum StatusSolicitacaoCorrecao {
  PENDENTE
  EM_REVISAO
  RESOLVIDA
  CANCELADA
}

/// Tipo de conteúdo alvo da correção
enum TipoAlvoCorrecao {
  DIARIO
  PLANEJAMENTO
  RELATORIO
  CADASTRO_ALUNO
  OUTRO
}

/// Solicitação de correção enviada por Central ou Unidade ao autor (professor)
model SolicitacaoCorrecao {
  id String @id @default(cuid())

  mantenedoraId String
  unitId        String

  criadoPorId   String @db.VarChar(255)
  responsavelId String @db.VarChar(255)

  tipoAlvo TipoAlvoCorrecao
  alvoId   String           @db.VarChar(255)

  mensagem String @db.Text

  status StatusSolicitacaoCorrecao @default(PENDENTE)

  respostaResolucao String? @db.Text

  criadoEm     DateTime  @default(now())
  atualizadoEm DateTime  @updatedAt
  resolvidaEm  DateTime?

  mantenedora Mantenedora @relation(fields: [mantenedoraId], references: [id], onDelete: Cascade)
  unit        Unit        @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@index([mantenedoraId])
  @@index([unitId])
  @@index([criadoPorId])
  @@index([responsavelId])
  @@index([status])
  @@index([tipoAlvo, alvoId])
}

// ============================================================================
// 16. ARQUIVO (anexos universais — doc/pdf/xls/jpg/png)
// ============================================================================
enum ArquivoEntidade {
  COORDENACAO_REUNIAO
  COORDENACAO_ATA
  FORMACAO
  ATENDIMENTO_PAIS
  RELATORIO_FOTO
  DIARIO
  PLANEJAMENTO
  RDIX_INSTANCIA
  OUTRO
}

model Arquivo {
  id             String          @id @default(cuid())
  mantenedoraId  String
  unitId         String?
  entidade       ArquivoEntidade
  entidadeId     String          @db.VarChar(255)
  nomeOriginal   String          @db.VarChar(255)
  nomeArquivo    String          @db.VarChar(255)
  mimeType       String          @db.VarChar(100)
  tamanhoBytes   Int
  caminho        String          @db.VarChar(500)
  uploadadoPorId String          @db.VarChar(255)
  criadoEm      DateTime        @default(now())
  mantenedora   Mantenedora     @relation(fields: [mantenedoraId], references: [id], onDelete: Cascade)
  @@index([mantenedoraId])
  @@index([entidade, entidadeId])
  @@index([uploadadoPorId])
}

// ============================================================================
// 17. COORDENAÇÕES (reuniões, pauta, ata, formações)
// ============================================================================
enum TipoCoordenacao {
  UNIDADE
  REDE
  FORMACAO
  EMERGENCIAL
}

enum StatusCoordenacao {
  RASCUNHO
  AGENDADA
  REALIZADA
  CANCELADA
  PUBLICADA
}

model CoordenacaoReuniao {
  id             String            @id @default(cuid())
  mantenedoraId  String
  unitId         String?
  tipo           TipoCoordenacao
  status         StatusCoordenacao @default(RASCUNHO)
  titulo         String            @db.VarChar(255)
  descricao      String?           @db.Text
  dataRealizacao DateTime
  localOuLink    String?           @db.VarChar(500)
  criadoPorId    String            @db.VarChar(255)
  publicadaEm   DateTime?
  criadoEm      DateTime          @default(now())
  atualizadoEm  DateTime          @updatedAt
  mantenedora   Mantenedora       @relation(fields: [mantenedoraId], references: [id], onDelete: Cascade)
  participantes CoordenacaoParticipante[]
  atas          CoordenacaoAta[]
  @@index([mantenedoraId])
  @@index([unitId])
  @@index([tipo])
  @@index([status])
  @@index([dataRealizacao])
}

model CoordenacaoParticipante {
  id          String   @id @default(cuid())
  reuniaoId   String
  usuarioId   String   @db.VarChar(255)
  nomeExterno String?  @db.VarChar(255)
  presente    Boolean  @default(false)
  criadoEm   DateTime @default(now())
  reuniao    CoordenacaoReuniao @relation(fields: [reuniaoId], references: [id], onDelete: Cascade)
  @@unique([reuniaoId, usuarioId])
  @@index([reuniaoId])
  @@index([usuarioId])
}

model CoordenacaoAta {
  id                  String   @id @default(cuid())
  reuniaoId           String
  conteudo            String   @db.Text
  pautaJson           Json?
  encaminhamentosJson Json?
  redigidoPorId       String   @db.VarChar(255)
  aprovadaEm         DateTime?
  criadoEm           DateTime @default(now())
  atualizadoEm       DateTime @updatedAt
  reuniao            CoordenacaoReuniao @relation(fields: [reuniaoId], references: [id], onDelete: Cascade)
  @@index([reuniaoId])
}

model Formacao {
  id            String   @id @default(cuid())
  mantenedoraId String
  unitId        String?
  titulo        String   @db.VarChar(255)
  descricao     String?  @db.Text
  ministrante   String?  @db.VarChar(255)
  dataInicio    DateTime
  dataFim       DateTime?
  cargaHoraria  Float?
  modalidade    String   @db.VarChar(50)
  criadoPorId   String   @db.VarChar(255)
  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt
  mantenedora  Mantenedora @relation(fields: [mantenedoraId], references: [id], onDelete: Cascade)
  @@index([mantenedoraId])
  @@index([unitId])
  @@index([dataInicio])
}

// ============================================================================
// 18. ATENDIMENTO AOS PAIS
// ============================================================================
enum StatusAtendimento {
  AGENDADO
  REALIZADO
  CANCELADO
  PENDENTE_RETORNO
}

enum TipoAtendimento {
  PRESENCIAL
  REMOTO
  TELEFONEMA
  MENSAGEM
}

model AtendimentoPais {
  id                  String            @id @default(cuid())
  mantenedoraId       String
  unitId              String
  childId             String
  responsavelNome     String            @db.VarChar(255)
  responsavelRelacao  String?           @db.VarChar(100)
  responsavelContato  String?           @db.VarChar(255)
  tipo                TipoAtendimento
  status              StatusAtendimento @default(AGENDADO)
  dataAtendimento     DateTime
  atendidoPorId       String            @db.VarChar(255)
  assunto             String            @db.VarChar(500)
  descricao           String?           @db.Text
  encaminhamento      String?           @db.Text
  retornoNecessario   Boolean           @default(false)
  dataRetorno         DateTime?
  criadoEm           DateTime           @default(now())
  atualizadoEm       DateTime           @updatedAt
  mantenedora        Mantenedora        @relation(fields: [mantenedoraId], references: [id], onDelete: Cascade)
  child              Child              @relation(fields: [childId], references: [id], onDelete: Cascade)
  @@index([mantenedoraId])
  @@index([unitId])
  @@index([childId])
  @@index([status])
  @@index([dataAtendimento])
}

// ============================================================================
// 19. RELATÓRIO DE FOTOS/EVIDÊNCIAS
// ============================================================================
model RelatorioFoto {
  id            String   @id @default(cuid())
  mantenedoraId String
  unitId        String
  classroomId   String
  titulo        String   @db.VarChar(255)
  descricao     String?  @db.Text
  dataAtividade DateTime
  criadoPorId   String   @db.VarChar(255)
  publicado     Boolean  @default(false)
  publicadoEm  DateTime?
  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt
  mantenedora  Mantenedora @relation(fields: [mantenedoraId], references: [id], onDelete: Cascade)
  @@index([mantenedoraId])
  @@index([unitId])
  @@index([classroomId])
  @@index([dataAtividade])
}

// ============================================================================
// 20. RDIX / RDIC
// ============================================================================
enum StatusRDIX {
  RASCUNHO
  EM_REVISAO
  FINALIZADO
  PUBLICADO
}

model RDIXTemplate {
  id            String   @id @default(cuid())
  mantenedoraId String
  segmento      String   @db.VarChar(50)
  titulo        String   @db.VarChar(255)
  estruturaJson Json
  ativo         Boolean  @default(true)
  criadoPorId   String   @db.VarChar(255)
  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt
  mantenedora  Mantenedora   @relation(fields: [mantenedoraId], references: [id], onDelete: Cascade)
  instancias   RDIXInstancia[]
  @@index([mantenedoraId])
  @@index([segmento])
}

model RDIXInstancia {
  id             String     @id @default(cuid())
  mantenedoraId  String
  unitId         String
  templateId     String
  childId        String
  classroomId    String
  periodo        String     @db.VarChar(50)
  anoLetivo      Int
  status         StatusRDIX @default(RASCUNHO)
  rascunhoJson   Json?
  conteudoFinal  Json?
  criadoPorId    String     @db.VarChar(255)
  revisadoPorId  String?    @db.VarChar(255)
  finalizadoEm  DateTime?
  publicadoEm   DateTime?
  criadoEm      DateTime   @default(now())
  atualizadoEm  DateTime   @updatedAt
  mantenedora   Mantenedora  @relation(fields: [mantenedoraId], references: [id], onDelete: Cascade)
  template      RDIXTemplate @relation(fields: [templateId], references: [id])
  child         Child        @relation(fields: [childId], references: [id], onDelete: Cascade)
  @@unique([childId, classroomId, periodo, anoLetivo])
  @@index([mantenedoraId])
  @@index([unitId])
  @@index([classroomId])
  @@index([status])
}

// ============================================================================
// 21. ALERTA OPERACIONAL + NOTIFICAÇÃO IN-APP
// ============================================================================
enum TipoAlerta {
  FALTA_CONSECUTIVA
  AUSENCIA_REGISTRO_DIARIO
  PLANEJAMENTO_PENDENTE
  RELATORIO_PENDENTE
  RDIX_PENDENTE
  MATERIAL_PENDENTE
  ATENDIMENTO_PENDENTE
  INCONSISTENCIA_DADOS
  OUTRO
}

enum SeveridadeAlerta {
  BAIXA
  MEDIA
  ALTA
  CRITICA
}

model AlertaOperacional {
  id             String           @id @default(cuid())
  mantenedoraId  String
  unitId         String?
  classroomId    String?
  childId        String?
  tipo           TipoAlerta
  severidade     SeveridadeAlerta @default(MEDIA)
  titulo         String           @db.VarChar(255)
  descricao      String           @db.Text
  metadados      Json?
  resolvido      Boolean          @default(false)
  resolvidoPorId String?          @db.VarChar(255)
  resolvidoEm   DateTime?
  criadoEm      DateTime          @default(now())
  mantenedora   Mantenedora      @relation(fields: [mantenedoraId], references: [id], onDelete: Cascade)
  notificacoes  Notificacao[]
  @@index([mantenedoraId])
  @@index([unitId])
  @@index([tipo])
  @@index([severidade])
  @@index([resolvido])
  @@index([criadoEm])
}

model Notificacao {
  id        String   @id @default(cuid())
  usuarioId String   @db.VarChar(255)
  alertaId  String?
  titulo    String   @db.VarChar(255)
  mensagem  String   @db.Text
  lida      Boolean  @default(false)
  lidaEm   DateTime?
  link      String?  @db.VarChar(500)
  criadoEm DateTime @default(now())
  alerta   AlertaOperacional? @relation(fields: [alertaId], references: [id], onDelete: SetNull)
  @@index([usuarioId])
  @@index([lida])
  @@index([criadoEm])
}

// ============================================================================
// 22. TEMPLATE OFFLINE
// ============================================================================
model TemplateOffline {
  id                   String   @id @default(cuid())
  mantenedoraId        String
  segmento             String   @db.VarChar(50)
  semana               Int?
  titulo               String   @db.VarChar(255)
  campoExperiencia     String?  @db.VarChar(255)
  objetivoBNCC         String?  @db.Text
  objetivoCurriculo    String?  @db.Text
  descricaoAtividade   String?  @db.Text
  materiaisNecessarios Json?
  duracaoMinutos       Int?
  ativo                Boolean  @default(true)
  criadoPorId          String   @db.VarChar(255)
  criadoEm            DateTime @default(now())
  atualizadoEm        DateTime @updatedAt
  mantenedora         Mantenedora @relation(fields: [mantenedoraId], references: [id], onDelete: Cascade)
  @@index([mantenedoraId])
  @@index([segmento])
  @@index([semana])
}

// ============================================================================
// 23. SYNC MUTATION (idempotência offline)
// ============================================================================
enum StatusSync {
  PENDENTE
  PROCESSADO
  ERRO
  IGNORADO
}

model SyncMutation {
  id           String     @id @default(cuid())
  clienteId    String     @db.VarChar(255)
  usuarioId    String     @db.VarChar(255)
  operacao     String     @db.VarChar(100)
  entidade     String     @db.VarChar(100)
  entidadeId   String?    @db.VarChar(255)
  payload      Json
  status       StatusSync @default(PENDENTE)
  erroMsg      String?    @db.Text
  processadoEm DateTime?
  criadoEm    DateTime   @default(now())
  @@unique([clienteId])
  @@index([usuarioId])
  @@index([status])
  @@index([criadoEm])
}

// ============================================================================
// 24. CATÁLOGO DE MATERIAIS
// ============================================================================

/// Catálogo de materiais disponíveis para requisição
model Material {
  id             String   @id @default(cuid())
  code           String   @unique @db.VarChar(50)
  name           String   @db.VarChar(255)
  description    String?  @db.Text
  category       String   @db.VarChar(50) // PEDAGOGICO, HIGIENE
  unit           String   @db.VarChar(50) // UN, Caixa, Pacote, Rolo, etc
  referencePrice Float?   @default(0.0)
  isActive       Boolean  @default(true)
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  requestItems   MaterialRequestItem[]
  
  @@index([category])
  @@index([isActive])
}

/// Itens de uma requisição de materiais
model MaterialRequestItem {
  id           String   @id @default(cuid())
  requestId    String
  request      MaterialRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  
  materialId   String
  material     Material @relation(fields: [materialId], references: [id])
  
  quantity     Int
  unitPrice    Float?
  totalPrice   Float?
  observations String?  @db.Text
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@index([requestId])
  @@index([materialId])
}

// ============================================================================
// 17. RELATÓRIOS INDIVIDUAIS DE DESENVOLVIMENTO (RDIC)
// ============================================================================

/// Observações de Desenvolvimento Individual da Criança (RDIC)
model DevelopmentObservation {
  id      String @id @default(cuid())
  childId String
  date    DateTime @default(now())

  // Categoria da observação
  category ObservationCategory

  // Comportamento
  behaviorDescription String? @db.Text
  socialInteraction   String? @db.Text
  emotionalState      String? @db.Text

  // Desenvolvimento
  motorSkills     String? @db.Text
  cognitiveSkills String? @db.Text
  languageSkills  String? @db.Text

  // Saúde e Bem-estar
  healthNotes  String? @db.Text
  dietaryNotes String? @db.Text
  sleepPattern String? @db.Text

  // Observações Pedagógicas
  learningProgress String? @db.Text
  interests        String? @db.Text
  challenges       String? @db.Text

  // Recomendações
  recommendations String? @db.Text
  nextSteps       String? @db.Text

  // Metadados
  createdBy String // userId do professor
  updatedAt DateTime @updatedAt

  // Relações
  child Child @relation(fields: [childId], references: [id], onDelete: Cascade)

  @@index([childId])
  @@index([date])
  @@index([category])
}

enum ObservationCategory {
  COMPORTAMENTO
  DESENVOLVIMENTO
  SAUDE
  APRENDIZAGEM
  GERAL
}

/// Relatório Individual de Desenvolvimento (RDI/RIA)
model DevelopmentReport {
  id      String @id @default(cuid())
  childId String

  // Período do relatório
  startDate DateTime
  endDate   DateTime

  // Tipo de relatório
  reportType ReportType

  // Conteúdo gerado automaticamente
  behaviorSummary    String @db.Text
  developmentSummary String @db.Text
  healthSummary      String @db.Text
  learningSummary    String @db.Text
  overallAssessment  String @db.Text
  recommendations    String @db.Text

  // Metadados
  generatedBy String // userId
  generatedAt DateTime @default(now())
  approvedBy  String? // coordenador
  approvedAt  DateTime?

  // Relações
  child Child @relation(fields: [childId], references: [id], onDelete: Cascade)

  @@index([childId])
  @@index([startDate, endDate])
  @@index([reportType])
}

enum ReportType {
  RDI // Relatório de Desenvolvimento Individual
  RIA // Relatório Individual de Aprendizagem
  RDIC // Relatório de Desenvolvimento Individual da Criança (completo)
  BIMESTRAL
  SEMESTRAL
  ANUAL
}
